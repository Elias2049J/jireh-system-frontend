<div class="modal-backdrop fade show"></div>

<div class="modal d-block">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          @if (actionType() === 'add') { Nuevo Producto } @else { Editar Producto }
        </h5>
        <button type="button" class="btn-close" (click)="cancel()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="productForm">
          <div class="mb-3">
            <label for="name" class="form-label">Nombre del producto</label>
            <input
              type="text"
              class="form-control"
              id="name"
              formControlName="name"
              [ngClass]="{'is-invalid': productForm.get('name')?.invalid && productForm.get('name')?.touched}"
            >
            @if (productForm.controls['name'].hasError('required') && productForm.controls['name'].touched) {
              <div class="invalid-feedback">El nombre es obligatorio</div>
            }
            @if (productForm.controls['name'].hasError('minlength')) {
              <div class="invalid-feedback">El nombre debe tener al menos 3 caracteres</div>
            }
            @if (productForm.controls['name'].hasError('maxlength')) {
              <div class="invalid-feedback">El nombre debe tener menos de 50 caracteres</div>
            }
            @if (productForm.controls['name'].hasError('pattern')) {
              <div class="invalid-feedback">El nombre solo puede contener letras, números y algunos caracteres especiales</div>
            }
          </div>

          <div class="mb-3">
            <label for="prefix" class="form-label">Prefijo (opcional)</label>
            <input
              type="text"
              class="form-control"
              id="prefix"
              formControlName="prefix"
              [ngClass]="{'is-invalid': productForm.get('prefix')?.invalid && productForm.get('prefix')?.touched}"
            >
            @if (productForm.controls['prefix'].hasError('maxlength')) {
              <div class="invalid-feedback">El prefijo debe tener menos de 30 caracteres</div>
            }
          </div>

          <div class="mb-3">
            <label for="price" class="form-label">Precio</label>
            <input
              type="number"
              step="0.01"
              class="form-control"
              id="price"
              formControlName="price"
              [ngClass]="{'is-invalid': productForm.get('price')?.invalid && productForm.get('price')?.touched}"
            >
            @if (productForm.controls['price'].hasError('required') && productForm.controls['price'].touched) {
              <div class="invalid-feedback">El precio es obligatorio</div>
            }
            @if (productForm.controls['price'].hasError('min')) {
              <div class="invalid-feedback">El precio debe ser mayor que 0</div>
            }
            @if (productForm.controls['price'].hasError('pattern')) {
              <div class="invalid-feedback">El precio debe ser un número válido</div>
            }
          </div>

          <!-- Listas de opciones dinámicas -->
          <div class="mb-3">
            <label class="form-label d-flex justify-content-between">
              <span>Listas de opciones</span>
              <button type="button" class="btn btn-sm btn-primary" (click)="addOptionListSlot()">
                Agregar lista de opciones
              </button>
            </label>

            @for (control of optionListControls; track $index) {
              <div class="d-flex mb-2 gap-2 align-items-center">
                <select class="form-select" [formControl]="control">
                  <option [ngValue]="null">Seleccione una lista de opciones</option>
                  @for (optionList of allOptionLists(); track optionList.idOptionList) {
                    <option [ngValue]="optionList.idOptionList">{{ optionList.name }}</option>
                  }
                </select>
                <button type="button" class="btn btn-sm btn-danger" (click)="removeOptionListSlot($index)">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            }

            @if (optionListControls.length === 0) {
              <div class="alert alert-info">
                Agregue listas de opciones usando el botón de arriba
              </div>
            }
          </div>

          @if (actionType() === 'edit') {
            <div class="mb-3">
              <label for="available" class="form-label">Disponibilidad</label>
              <select
                class="form-select"
                id="available"
                formControlName="available"
              >
                <option [ngValue]="true">Disponible</option>
                <option [ngValue]="false">No Disponible</option>
              </select>
            </div>
          }

          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" (click)="cancel()">Cancelar</button>
            <button type="button" class="btn btn-primary" (click)="submit()" [disabled]="productForm.invalid">
              @if (actionType() === 'add') { Registrar } @else { Actualizar }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
